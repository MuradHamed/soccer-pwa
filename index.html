import React, { createContext, useContext, useReducer, useState, useEffect } from 'react';

// State Management with Context
const AppContext = createContext();

const initialState = {
  players: [],
  orangeTeam: [],
  greenTeam: []
};

function appReducer(state, action) {
  switch (action.type) {
    case 'ADD_PLAYER':
      return {
        ...state,
        players: [...state.players, { id: Date.now(), name: action.payload }]
      };
    case 'REMOVE_PLAYER':
      return {
        ...state,
        players: state.players.filter(p => p.id !== action.payload),
        orangeTeam: state.orangeTeam.filter(p => p.id !== action.payload),
        greenTeam: state.greenTeam.filter(p => p.id !== action.payload)
      };
    case 'MOVE_TO_ORANGE':
      const playerForOrange = state.players.find(p => p.id === action.payload);
      if (!playerForOrange) return state;
      return {
        ...state,
        orangeTeam: [...state.orangeTeam.filter(p => p.id !== action.payload), playerForOrange],
        greenTeam: state.greenTeam.filter(p => p.id !== action.payload)
      };
    case 'MOVE_TO_GREEN':
      const playerForGreen = state.players.find(p => p.id === action.payload);
      if (!playerForGreen) return state;
      return {
        ...state,
        greenTeam: [...state.greenTeam.filter(p => p.id !== action.payload), playerForGreen],
        orangeTeam: state.orangeTeam.filter(p => p.id !== action.payload)
      };
    case 'REMOVE_FROM_TEAM':
      return {
        ...state,
        orangeTeam: state.orangeTeam.filter(p => p.id !== action.payload),
        greenTeam: state.greenTeam.filter(p => p.id !== action.payload)
      };
    default:
      return state;
  }
}

function AppProvider({ children }) {
  const [state, dispatch] = useReducer(appReducer, initialState);
  
  return (
    <AppContext.Provider value={{ state, dispatch }}>
      {children}
    </AppContext.Provider>
  );
}

function useApp() {
  const context = useContext(AppContext);
  if (!context) {
    throw new Error('useApp must be used within AppProvider');
  }
  return context;
}

// Components
function NavBar() {
  return (
    <nav className="bg-gray-900 border-b border-gray-700 px-4 py-3">
      <h1 className="text-white text-xl font-bold text-center">âš½ Soccer Teams</h1>
    </nav>
  );
}

function TabBar({ activeTab, onTabChange }) {
  return (
    <div className="bg-gray-800 border-b border-gray-700">
      <div className="flex">
        <button 
          onClick={() => onTabChange('add-remove')}
          className={`flex-1 py-3 text-center font-medium transition-colors ${
            activeTab === 'add-remove' 
              ? 'text-blue-400 bg-gray-700 border-b-2 border-blue-400' 
              : 'text-gray-300 hover:text-white hover:bg-gray-700'
          }`}
        >
          Add / Remove
        </button>
        <button 
          onClick={() => onTabChange('teams')}
          className={`flex-1 py-3 text-center font-medium transition-colors ${
            activeTab === 'teams' 
              ? 'text-blue-400 bg-gray-700 border-b-2 border-blue-400' 
              : 'text-gray-300 hover:text-white hover:bg-gray-700'
          }`}
        >
          Teams
        </button>
      </div>
    </div>
  );
}

function AddRemoveTab() {
  const { state, dispatch } = useApp();
  const [inputValue, setInputValue] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (inputValue.trim()) {
      dispatch({ type: 'ADD_PLAYER', payload: inputValue.trim() });
      setInputValue('');
    }
  };

  const handleRemovePlayer = (id) => {
    dispatch({ type: 'REMOVE_PLAYER', payload: id });
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleSubmit(e);
    }
  };

  return (
    <div className="p-4 max-w-md mx-auto">
      <div className="mb-6">
        <div className="flex gap-2">
          <input
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Enter player name"
            className="flex-1 px-4 py-3 bg-gray-800 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
          />
          <button
            onClick={handleSubmit}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
          >
            Add
          </button>
        </div>
      </div>

      <div className="space-y-2">
        <h2 className="text-white text-lg font-semibold mb-3">
          Players ({state.players.length})
        </h2>
        {state.players.length === 0 ? (
          <p className="text-gray-400 text-center py-8 italic">
            No players yet. Add some names above!
          </p>
        ) : (
          <div className="space-y-2">
            {state.players.map((player) => (
              <div
                key={player.id}
                onClick={() => handleRemovePlayer(player.id)}
                className="flex items-center justify-between p-3 bg-gray-800 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-700 transition-colors"
              >
                <span className="text-white">{player.name}</span>
                <span className="text-red-400 text-sm">Tap to remove</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function DragDropTeam({ team, teamColor, onDrop, onRemove, title }) {
  const [dragOver, setDragOver] = useState(false);

  const handleDragOver = (e) => {
    e.preventDefault();
    setDragOver(true);
  };

  const handleDragLeave = (e) => {
    e.preventDefault();
    setDragOver(false);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const playerId = parseInt(e.dataTransfer.getData('text/plain'));
    onDrop(playerId);
  };

  const colorClasses = {
    orange: dragOver ? 'border-orange-300 bg-orange-500/20' : 'border-orange-500 bg-orange-500/10',
    green: dragOver ? 'border-green-300 bg-green-500/20' : 'border-green-500 bg-green-500/10'
  };

  return (
    <div 
      className={`flex-1 min-h-64 p-4 border-2 border-dashed rounded-lg transition-colors ${colorClasses[teamColor]}`}
      onDragOver={handleDragOver}
      onDragLeave={handleDragLeave}
      onDrop={handleDrop}
    >
      <h3 className={`text-lg font-bold mb-3 text-center ${teamColor === 'orange' ? 'text-orange-400' : 'text-green-400'}`}>
        {title} ({team.length})
      </h3>
      <div className="space-y-2">
        {team.map((player) => (
          <div
            key={player.id}
            className="p-2 bg-gray-800 rounded text-white text-center cursor-pointer hover:bg-gray-700 transition-colors relative group"
            onClick={() => onRemove(player.id)}
          >
            {player.name}
            <span className="absolute top-1 right-2 text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
              Ã—
            </span>
          </div>
        ))}
        {team.length === 0 && (
          <p className="text-gray-400 text-center py-8 italic">
            Drag players here
          </p>
        )}
      </div>
    </div>
  );
}

function TeamsTab() {
  const { state, dispatch } = useApp();

  const handleDragStart = (e, playerId) => {
    e.dataTransfer.setData('text/plain', playerId.toString());
  };

  const handleMoveToOrange = (playerId) => {
    dispatch({ type: 'MOVE_TO_ORANGE', payload: playerId });
  };

  const handleMoveToGreen = (playerId) => {
    dispatch({ type: 'MOVE_TO_GREEN', payload: playerId });
  };

  const handleRemoveFromTeam = (playerId) => {
    dispatch({ type: 'REMOVE_FROM_TEAM', payload: playerId });
  };

  const availablePlayers = state.players.filter(
    player => !state.orangeTeam.find(p => p.id === player.id) && 
              !state.greenTeam.find(p => p.id === player.id)
  );

  return (
    <div className="p-4 max-w-4xl mx-auto">
      {/* Available Players */}
      <div className="mb-6">
        <h2 className="text-white text-lg font-semibold mb-3">
          Available Players ({availablePlayers.length})
        </h2>
        {availablePlayers.length === 0 ? (
          <p className="text-gray-400 text-center py-4 italic">
            {state.players.length === 0 ? 'No players added yet. Go to Add/Remove tab to add players.' : 'All players are assigned to teams'}
          </p>
        ) : (
          <div className="flex flex-wrap gap-2">
            {availablePlayers.map((player) => (
              <div
                key={player.id}
                draggable
                onDragStart={(e) => handleDragStart(e, player.id)}
                className="px-3 py-2 bg-gray-700 text-white rounded-lg cursor-move hover:bg-gray-600 transition-colors select-none"
              >
                {player.name}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Teams */}
      <div className="flex gap-4 flex-col sm:flex-row">
        <DragDropTeam
          team={state.orangeTeam}
          teamColor="orange"
          onDrop={handleMoveToOrange}
          onRemove={handleRemoveFromTeam}
          title="ðŸŸ  Orange Team"
        />
        <DragDropTeam
          team={state.greenTeam}
          teamColor="green"
          onDrop={handleMoveToGreen}
          onRemove={handleRemoveFromTeam}
          title="ðŸŸ¢ Green Team"
        />
      </div>
    </div>
  );
}

function App() {
  const [activeTab, setActiveTab] = useState('add-remove');

  // PWA Install prompt
  useEffect(() => {
    let deferredPrompt;
    
    const handleBeforeInstallPrompt = (e) => {
      e.preventDefault();
      deferredPrompt = e;
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  return (
    <AppProvider>
      <div className="min-h-screen bg-gray-900">
        <NavBar />
        <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
        <main className="pb-4">
          {activeTab === 'add-remove' && <AddRemoveTab />}
          {activeTab === 'teams' && <TeamsTab />}
        </main>
      </div>
    </AppProvider>
  );
}

export default App;
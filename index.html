import React, { createContext, useContext, useReducer, useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';

// Supabase client with your actual credentials
const supabaseUrl = 'https://rqpcxbzfvufekaihnmct.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxcGN4YnpmdnVmZWthaWhubWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMzA4NTAsImV4cCI6MjA2NDgwNjg1MH0.mo6COppydSth-qsLGmREFP1yETVpGH1f3CBXbhKDs4M';
const supabase = createClient(supabaseUrl, supabaseKey);

// State Management with Context
const AppContext = createContext();

const initialState = {
  players: [],
  orangeTeam: [],
  greenTeam: [],
  loading: false,
  error: null
};

function appReducer(state, action) {
  switch (action.type) {
    case 'SET_LOADING':
      return { ...state, loading: action.payload };
    case 'SET_ERROR':
      return { ...state, error: action.payload, loading: false };
    case 'SET_PLAYERS':
      return { ...state, players: action.payload, loading: false };
    case 'SET_TEAMS':
      return { 
        ...state, 
        orangeTeam: action.payload.orange,
        greenTeam: action.payload.green,
        loading: false 
      };
    case 'ADD_PLAYER_LOCAL':
      return {
        ...state,
        players: [...state.players, action.payload]
      };
    case 'REMOVE_PLAYER_LOCAL':
      return {
        ...state,
        players: state.players.filter(p => p.id !== action.payload),
        orangeTeam: state.orangeTeam.filter(p => p.id !== action.payload),
        greenTeam: state.greenTeam.filter(p => p.id !== action.payload)
      };
    case 'UPDATE_TEAMS_LOCAL':
      return {
        ...state,
        orangeTeam: action.payload.orange,
        greenTeam: action.payload.green
      };
    default:
      return state;
  }
}

function AppProvider({ children }) {
  const [state, dispatch] = useReducer(appReducer, initialState);
  
  // Load data on app start
  useEffect(() => {
    loadPlayers();
    loadTeams();
  }, []);

  const loadPlayers = async () => {
    try {
      dispatch({ type: 'SET_LOADING', payload: true });
      const { data, error } = await supabase
        .from('players')
        .select('*')
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      dispatch({ type: 'SET_PLAYERS', payload: data || [] });
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error loading players:', error);
    }
  };

  const loadTeams = async () => {
    try {
      const { data, error } = await supabase
        .from('teams')
        .select(`
          player_id,
          team_color,
          players (id, name)
        `);
      
      if (error) throw error;
      
      const orange = data?.filter(t => t.team_color === 'orange').map(t => t.players) || [];
      const green = data?.filter(t => t.team_color === 'green').map(t => t.players) || [];
      
      dispatch({ type: 'SET_TEAMS', payload: { orange, green } });
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error loading teams:', error);
    }
  };

  const addPlayer = async (name) => {
    try {
      const { data, error } = await supabase
        .from('players')
        .insert([{ name }])
        .select()
        .single();
      
      if (error) throw error;
      dispatch({ type: 'ADD_PLAYER_LOCAL', payload: data });
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error adding player:', error);
    }
  };

  const removePlayer = async (playerId) => {
    try {
      // Remove from teams first
      await supabase
        .from('teams')
        .delete()
        .eq('player_id', playerId);
      
      // Then remove player
      const { error } = await supabase
        .from('players')
        .delete()
        .eq('id', playerId);
      
      if (error) throw error;
      dispatch({ type: 'REMOVE_PLAYER_LOCAL', payload: playerId });
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error removing player:', error);
    }
  };

  const moveToTeam = async (playerId, teamColor) => {
    try {
      // Remove from any existing team
      await supabase
        .from('teams')
        .delete()
        .eq('player_id', playerId);
      
      // Add to new team
      const { error } = await supabase
        .from('teams')
        .insert([{ player_id: playerId, team_color: teamColor }]);
      
      if (error) throw error;
      
      // Reload teams to get updated state
      await loadTeams();
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error moving player to team:', error);
    }
  };

  const removeFromTeam = async (playerId) => {
    try {
      const { error } = await supabase
        .from('teams')
        .delete()
        .eq('player_id', playerId);
      
      if (error) throw error;
      await loadTeams();
    } catch (error) {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      console.error('Error removing from team:', error);
    }
  };
  
  return (
    <AppContext.Provider value={{ 
      state, 
      dispatch,
      addPlayer,
      removePlayer,
      moveToTeam,
      removeFromTeam,
      loadPlayers,
      loadTeams
    }}>
      {children}
    </AppContext.Provider>
  );
}

function useApp() {
  const context = useContext(AppContext);
  if (!context) {
    throw new Error('useApp must be used within AppProvider');
  }
  return context;
}

// Components
function NavBar() {
  return (
    <nav className="bg-gray-900 border-b border-gray-700 px-4 py-3">
      <h1 className="text-white text-xl font-bold text-center">⚽ Soccer Teams</h1>
    </nav>
  );
}

function TabBar({ activeTab, onTabChange }) {
  return (
    <div className="bg-gray-800 border-b border-gray-700">
      <div className="flex">
        <button 
          onClick={() => onTabChange('add-remove')}
          className={`flex-1 py-3 text-center font-medium transition-colors ${
            activeTab === 'add-remove' 
              ? 'text-blue-400 bg-gray-700 border-b-2 border-blue-400' 
              : 'text-gray-300 hover:text-white hover:bg-gray-700'
          }`}
        >
          Add / Remove
        </button>
        <button 
          onClick={() => onTabChange('teams')}
          className={`flex-1 py-3 text-center font-medium transition-colors ${
            activeTab === 'teams' 
              ? 'text-blue-400 bg-gray-700 border-b-2 border-blue-400' 
              : 'text-gray-300 hover:text-white hover:bg-gray-700'
          }`}
        >
          Teams
        </button>
      </div>
    </div>
  );
}

function ErrorBanner({ error, onDismiss }) {
  if (!error) return null;
  
  return (
    <div className="bg-red-900 border border-red-700 text-red-200 px-4 py-3 mx-4 mt-4 rounded-lg flex justify-between items-center">
      <span>{error}</span>
      <button 
        onClick={onDismiss}
        className="text-red-400 hover:text-red-200 ml-4"
      >
        ×
      </button>
    </div>
  );
}

function AddRemoveTab() {
  const { state, addPlayer, removePlayer, dispatch } = useApp();
  const [inputValue, setInputValue] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (inputValue.trim()) {
      await addPlayer(inputValue.trim());
      setInputValue('');
    }
  };

  const handleRemovePlayer = async (id) => {
    await removePlayer(id);
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleSubmit(e);
    }
  };

  return (
    <div className="p-4 max-w-md mx-auto">
      <ErrorBanner 
        error={state.error} 
        onDismiss={() => dispatch({ type: 'SET_ERROR', payload: null })} 
      />
      
      <div className="mb-6">
        <div className="flex gap-2">
          <input
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Enter player name"
            disabled={state.loading}
            className="flex-1 px-4 py-3 bg-gray-800 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 disabled:opacity-50"
          />
          <button
            onClick={handleSubmit}
            disabled={state.loading || !inputValue.trim()}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {state.loading ? '...' : 'Add'}
          </button>
        </div>
      </div>

      <div className="space-y-2">
        <h2 className="text-white text-lg font-semibold mb-3">
          Players ({state.players.length})
        </h2>
        {state.loading ? (
          <p className="text-gray-400 text-center py-8">Loading...</p>
        ) : state.players.length === 0 ? (
          <p className="text-gray-400 text-center py-8 italic">
            No players yet. Add some names above!
          </p>
        ) : (
          <div className="space-y-2">
            {state.players.map((player) => (
              <div
                key={player.id}
                onClick={() => handleRemovePlayer(player.id)}
                className="flex items-center justify-between p-3 bg-gray-800 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-700 transition-colors"
              >
                <span className="text-white">{player.name}</span>
                <span className="text-red-400 text-sm">Tap to remove</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function DragDropTeam({ team, teamColor, onDrop, onRemove, title }) {
  const [dragOver, setDragOver] = useState(false);

  const handleDragOver = (e) => {
    e.preventDefault();
    setDragOver(true);
  };

  const handleDragLeave = (e) => {
    e.preventDefault();
    setDragOver(false);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const playerId = parseInt(e.dataTransfer.getData('text/plain'));
    onDrop(playerId);
  };

  const colorClasses = {
    orange: dragOver ? 'border-orange-300 bg-orange-500/20' : 'border-orange-500 bg-orange-500/10',
    green: dragOver ? 'border-green-300 bg-green-500/20' : 'border-green-500 bg-green-500/10'
  };

  return (
    <div 
      className={`flex-1 min-h-64 p-4 border-2 border-dashed rounded-lg transition-colors ${colorClasses[teamColor]}`}
      onDragOver={handleDragOver}
      onDragLeave={handleDragLeave}
      onDrop={handleDrop}
    >
      <h3 className={`text-lg font-bold mb-3 text-center ${teamColor === 'orange' ? 'text-orange-400' : 'text-green-400'}`}>
        {title} ({team.length})
      </h3>
      <div className="space-y-2">
        {team.map((player) => (
          <div
            key={player.id}
            className="p-2 bg-gray-800 rounded text-white text-center cursor-pointer hover:bg-gray-700 transition-colors relative group"
            onClick={() => onRemove(player.id)}
          >
            {player.name}
            <span className="absolute top-1 right-2 text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
              ×
            </span>
          </div>
        ))}
        {team.length === 0 && (
          <p className="text-gray-400 text-center py-8 italic">
            Drag players here
          </p>
        )}
      </div>
    </div>
  );
}

function TeamsTab() {
  const { state, moveToTeam, removeFromTeam, dispatch } = useApp();

  const handleDragStart = (e, playerId) => {
    e.dataTransfer.setData('text/plain', playerId.toString());
  };

  const handleMoveToOrange = async (playerId) => {
    await moveToTeam(playerId, 'orange');
  };

  const handleMoveToGreen = async (playerId) => {
    await moveToTeam(playerId, 'green');
  };

  const handleRemoveFromTeam = async (playerId) => {
    await removeFromTeam(playerId);
  };

  const availablePlayers = state.players.filter(
    player => !state.orangeTeam.find(p => p.id === player.id) && 
              !state.greenTeam.find(p => p.id === player.id)
  );

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <ErrorBanner 
        error={state.error} 
        onDismiss={() => dispatch({ type: 'SET_ERROR', payload: null })} 
      />
      
      {/* Available Players */}
      <div className="mb-6">
        <h2 className="text-white text-lg font-semibold mb-3">
          Available Players ({availablePlayers.length})
        </h2>
        {state.loading ? (
          <p className="text-gray-400 text-center py-4">Loading...</p>
        ) : availablePlayers.length === 0 ? (
          <p className="text-gray-400 text-center py-4 italic">
            {state.players.length === 0 ? 'No players added yet. Go to Add/Remove tab to add players.' : 'All players are assigned to teams'}
          </p>
        ) : (
          <div className="flex flex-wrap gap-2">
            {availablePlayers.map((player) => (
              <div
                key={player.id}
                draggable
                onDragStart={(e) => handleDragStart(e, player.id)}
                className="px-3 py-2 bg-gray-700 text-white rounded-lg cursor-move hover:bg-gray-600 transition-colors select-none"
              >
                {player.name}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Teams */}
      <div className="flex gap-4 flex-col sm:flex-row">
        <DragDropTeam
          team={state.orangeTeam}
          teamColor="orange"
          onDrop={handleMoveToOrange}
          onRemove={handleRemoveFromTeam}
          title="🟠 Orange Team"
        />
        <DragDropTeam
          team={state.greenTeam}
          teamColor="green"
          onDrop={handleMoveToGreen}
          onRemove={handleRemoveFromTeam}
          title="🟢 Green Team"
        />
      </div>
    </div>
  );
}

function App() {
  const [activeTab, setActiveTab] = useState('add-remove');

  return (
    <AppProvider>
      <div className="min-h-screen bg-gray-900">
        <NavBar />
        <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
        <main className="pb-4">
          {activeTab === 'add-remove' && <AddRemoveTab />}
          {activeTab === 'teams' && <TeamsTab />}
        </main>
      </div>
    </AppProvider>
  );
}

export default App;